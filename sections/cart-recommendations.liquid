<script
  src="{{ 'product-recommendations.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>

{% liquid
  # The product_id is injected at render-time from the cart context via data-product-id
  # The limit comes from the global cart_recommendations_count setting
  assign rec_limit = settings.cart_recommendations_count | default: 4

  # Build slides from recommendations (when served via Section Rendering API)
  if recommendations.performed
    if recommendations.products_count > 0
      assign rec_products = recommendations.products
    else
      assign rec_products = collections.all.products | reject: 'id', product.id
    endif
  endif

  # Resolve carousel arrow visibility from global setting
  assign show_arrows = false
  if settings.cart_rec_icons_style != 'none'
    assign show_arrows = true
  endif
%}

<product-recommendations
  id="product-recommendations-cart-recommendations"
  class="cart-recommendations"
  data-url="{{ routes.product_recommendations_url }}?limit={{ rec_limit }}"
  data-section-id="{{ section.id }}"
  data-product-id="{{ product.id }}"
  data-intent="related"
  data-recommendations-performed="{{ recommendations.performed }}"
  {{ section.shopify_attributes }}
>
  {%- if recommendations.performed -%}
    {% capture list_items %}
      {% for rec_product in rec_products limit: rec_limit %}
        <div class="resource-list__item cart-recommendations__card">
          {% render 'resource-card',
            resource: rec_product,
            resource_type: 'product',
            image_aspect_ratio: 'portrait',
            image_hover: true,
            image_sizes: '160px'
          %}
        </div>
        {% unless forloop.last %}
          <!--@list/split-->
        {% endunless %}
      {% endfor %}
    {% endcapture %}

    {% liquid
      assign slide_content = list_items | strip
      assign slides = slide_content | split: '<!--@list/split-->'

      if rec_products != blank and rec_products.size > 0
        assign has_recommendations = 'true'
      else
        assign has_recommendations = 'false'
      endif
    %}

    <div
      class="resource-list resource-list__carousel force-full-width cart-recommendations__list"
      data-has-recommendations="{{ has_recommendations }}"
      style="--resource-list-column-gap-desktop: {{ settings.cart_rec_columns_gap | default: 12 }}px;"
    >
      {%- comment -%}
        We inline the carousel here (instead of using render 'resource-list-carousel')
        because resource-list-carousel requires a section/block settings object and this
        section cannot be directly edited from the theme customizer.
        Arrow icon style and shape are controlled via global theme settings.
      {%- endcomment -%}

      {% capture carousel_slides %}
        {% for slide in slides limit: slides.size %}
          {% render 'slideshow-slide',
            index: forloop.index0,
            children: slide,
            class: 'resource-list__slide'
          %}
        {% endfor %}
      {% endcapture %}

      <div
        class="resource-list__carousel"
        style="--gutter-slide-width: 0px; --slide-width-max: 160px;"
      >
        {% render 'slideshow',
          ref: 'cartRecommendationsCarousel',
          class: 'resource-list__carousel',
          slides: carousel_slides,
          show_arrows: show_arrows,
          icon_style: settings.cart_rec_icons_style,
          icon_shape: settings.cart_rec_icons_shape,
          auto_hide_controls: false,
          infinite: false,
          initial_slide: 0,
          slide_count: rec_products.size
        %}
      </div>
    </div>
  {%- else -%}
    <div class="cart-recommendations__skeleton resource-list resource-list__carousel force-full-width">
      {% for i in (1..rec_limit) %}
        <div class="product-recommendations__skeleton-item"></div>
      {% endfor %}
    </div>
  {%- endif -%}
</product-recommendations>

{% stylesheet %}
  .cart-recommendations {
    display: block;
  }

  .cart-recommendations.hidden {
    display: none;
  }

  .cart-recommendations__skeleton {
    display: flex;
    gap: var(--gap-md);
    overflow: hidden;
    padding-inline: var(--cart-drawer-padding);

    @media screen and (min-width: 750px) {
      padding-inline: var(--cart-drawer-padding-desktop);
    }
  }

  .cart-recommendations__skeleton .product-recommendations__skeleton-item {
    flex: 0 0 150px;
    aspect-ratio: 3 / 4;
  }

  /* Compact resource-card styles for the cart drawer */
  .cart-recommendations__card .resource-card__title {
    font-size: var(--font-size--sm);
    line-height: 1.3;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    font-family: var(--font-accent--family);
    font-weight: var(--font-accent--weight);
    text-transform: uppercase;
    text-wrap: pretty;
    line-height: var(--line-height--body-normal);
    letter-spacing: var(--letter-spacing--body-normal);
  }

  .cart-recommendations__card .resource-card__price {
    font-size: var(--font-size--sm);
  }

  .cart-recommendations__card .resource-card__content {
    padding-block: 0;
    gap: 10px;

    [ref="priceContainer"] {
      display: flex;
      flex-direction: row;
      align-items: end;
      gap: 5px;

      [role="group"] {
        line-height: 25px;
      }

      .compare-at-price {
        font-size: var(--font-size--sm);
        font-weight: normal;
      }

      &:has(.compare-at-price) .price {
        color: var(--color-price-discount);
      }
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Cart recommendations",
  "settings": [],
  "presets": []
}
{% endschema %}
