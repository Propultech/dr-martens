{% liquid
  assign description_html = ''

  if block.settings.text != blank
    assign description_html = block.settings.text
  endif

  if request.visual_preview_mode and description_html == blank
    assign preview_product = collections.all.products.first
    if preview_product
      assign description_html = preview_product.description
    endif
  endif

  assign description_plain = description_html | strip_html | replace: '&nbsp;', ' ' | strip
  assign description_display_mode = block.settings.description_display_mode | default: 'normal'
  assign description_preview_lines = block.settings.description_preview_lines | default: 3
  assign description_preview_limit = description_preview_lines | times: 90
  assign description_preview_heading = ''
  assign description_preview_body_plain = description_plain
  assign heading_chunk = ''
  assign description_preview_needs_truncation = false
  assign show_description_preview_modal = false
  if description_display_mode == 'excerpt_modal' and description_plain != blank
    assign show_description_preview_modal = true
  endif

  if description_html contains '<h1'
    assign heading_chunk = description_html | split: '<h1' | slice: 1, 1 | first | split: '</h1>' | first
  elsif description_html contains '<h2'
    assign heading_chunk = description_html | split: '<h2' | slice: 1, 1 | first | split: '</h2>' | first
  elsif description_html contains '<h3'
    assign heading_chunk = description_html | split: '<h3' | slice: 1, 1 | first | split: '</h3>' | first
  elsif description_html contains '<h4'
    assign heading_chunk = description_html | split: '<h4' | slice: 1, 1 | first | split: '</h4>' | first
  elsif description_html contains '<h5'
    assign heading_chunk = description_html | split: '<h5' | slice: 1, 1 | first | split: '</h5>' | first
  elsif description_html contains '<h6'
    assign heading_chunk = description_html | split: '<h6' | slice: 1, 1 | first | split: '</h6>' | first
  endif

  if heading_chunk != blank
    assign heading_inner_html = heading_chunk | split: '>' | slice: 1, 50 | join: '>'
    assign description_preview_heading = heading_inner_html | strip_html | split: '<' | first | split: '&lt;' | first | strip
  endif

  if description_preview_heading != blank
    assign description_preview_body_plain = description_plain | remove_first: description_preview_heading | strip
  endif

  assign description_preview_text = description_preview_body_plain | strip_newlines | replace: '  ', ' ' | strip
  if description_preview_text.size > description_preview_limit
    assign description_preview_text = description_preview_text | truncate: description_preview_limit, '...'
    assign description_preview_needs_truncation = true
  endif

  assign visibility_class = ''
  if block.settings.visibility == 'desktop'
    assign visibility_class = ' hidden--mobile'
  elsif block.settings.visibility == 'mobile'
    assign visibility_class = ' hidden--desktop'
  endif
%}

{% if show_description_preview_modal %}
  <script
    src="{{ 'dialog.js' | asset_url }}"
    type="module"
  ></script>
{% endif %}

{% if show_description_preview_modal %}
  {% liquid
    assign description_modal_button_label = block.settings.description_preview_button_label | strip
    if description_modal_button_label == blank
      assign description_modal_button_label = 'content.read_more' | t
    endif
  %}
  <div
    class="product-description__container product-description__container--{{ block.settings.description_content_width | default: 'contained' }}{{ visibility_class }}"
  >
    <div
      class="product-description__excerpt"
      style="
        {% render 'spacing-padding', settings: block.settings %}
        {% render 'typography-style', settings: block.settings %}
      "
    >
    {% if description_preview_heading != blank %}
      <h3 class="product-description__preview-heading">{{ description_preview_heading | escape }}</h3>
    {% endif %}
    <div class="product-description__preview-row">
      <span class="product-description__preview-text">{{ description_preview_text }}</span>
      {% if description_preview_needs_truncation %}
        <dialog-component class="product-description__dialog product-description__dialog--inline">
        <button
          class="button button-unstyled product-description__preview-button"
          type="button"
          on:click="/showDialog"
        >
          {{ description_modal_button_label }}
          <span class="svg-wrapper">{{ 'icon-chevron-right.svg' | inline_asset_content }}</span>
        </button>
        <dialog
          ref="dialog"
          class="dialog-modal product-description__modal color-{{ settings.popover_color_scheme }}{% if block.settings.description_modal_behavior == 'drawer' %} product-description__modal--drawer dialog-drawer dialog-drawer--right{% endif %}"
          scroll-lock
          aria-label="{{ closest.product.title | default: shop.name | escape }}"
        >
          <div class="rte product-description__modal-content">
            {{ description_html }}
          </div>
          <button
            type="button"
            class="button button-unstyled close-button product-description__modal-close"
            aria-label="{{ 'actions.close' | t }}"
            on:click="/closeDialog"
          >
            <span class="visually-hidden">{{ 'actions.close' | t }}</span>
            {{ 'icon-close.svg' | inline_asset_content }}
          </button>
        </dialog>
      </dialog-component>
      {% endif %}
    </div>
    </div>
  </div>
{% else %}
  <div class="product-description__container product-description__container--{{ block.settings.description_content_width | default: 'contained' }}{{ visibility_class }}">
    {% render 'text', fallback_text: description_html, block: block %}
  </div>
{% endif %}

{% style %}
  .product-description__container {
    width: 100%;
  }

  .product-description__container--contained {
    max-width: var(--narrow-content-width);
  }

  .product-description__container--full {
    margin: 0 calc(var(--page-margin) * -1);
    width: calc(100% + (var(--page-margin) * 2));
  }

  .product-description__excerpt {
    width: 100%;
    padding: 30px var(--page-margin) 23px;
    border-top: 20px solid #E3E3E3;
    border-bottom: 20px solid #E3E3E3;
  }

  .product-description__preview-heading {
    margin: 0 0 12px;
    font-family: var(--font-body--family);
    font-size: var(--font-size--sm);
    font-weight: var(--font-accent--weight, 800);
    line-height: 18px;
    letter-spacing: .25px;
    text-transform: uppercase;
  }

  .product-description__preview-row {
    font-size: var(--font-paragraph--size);
    line-height: 137.5%;
  }

  .product-description__preview-text {
    margin: 0;
    text-wrap: pretty;
  }

  .product-description__dialog--inline {
    display: inline;
  }

  .product-description__preview-button {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    margin-inline-start: var(--gap-3xs);
    font-weight: var(--font-subheading--weight);
    font-size: var(--font-size--md);
    text-decoration: underline;
    text-transform: none;
    font-family: var(--font-body--family);
    font-stretch: normal;

    .svg-wrapper {
      width: 8px;
      height: 20px;
    }
  }

  .product-description__modal:not(.product-description__modal--drawer) {
    background-color: var(--color-background);
    color: var(--color-foreground);
    border-radius: var(--style-border-radius-popover);
    border: var(--style-border-popover);
    box-shadow: var(--shadow-popover);
    width: min(680px, calc(100vw - var(--padding-xl) * 2));
    max-height: var(--modal-max-height);
    padding: var(--padding-xl);
  }

  .product-description__modal--drawer {
    background-color: var(--color-variant-background);
    color: var(--color-variant-text);
    border: var(--style-border-popover);
    border-radius: 0;
    box-shadow: var(--shadow-popover);
    position: fixed;
    width: var(--sidebar-width);
    max-width: 95vw;
    height: 100%;
    margin: 0 0 0 auto;
    padding: 60px 20px 60px;
  }

  .product-description__modal--drawer:modal {
    max-height: 100dvh;
  }

  .product-description__modal--drawer[open] {
    --start-x: 100%;
    --end-x: 0px;
    --start-opacity: 1;
  }

  .product-description__modal--drawer[open].dialog-closing {
    --start-x: 0px;
    --end-x: 100%;
    --start-opacity: 1;
    --end-opacity: 1;
  }

  .product-description__modal:not(.product-description__modal--drawer)[open] {
    animation: modalSlideInTop var(--animation-speed) var(--animation-easing) forwards;
  }

  .product-description__modal:not(.product-description__modal--drawer).dialog-closing {
    animation: modalSlideOutTop var(--animation-speed) var(--animation-easing) forwards;
  }

  .product-description__modal-content {
    padding-right: var(--padding-xl);

    > h3 {
      margin: 0 0 8px;
      padding: 0 0 8px;
    }

    > div {
      margin: 0 0 16px;
      padding: 0 0 16px;
      border-bottom: 1px solid var(--color-border);
    }

    > h3:first-of-type {
      border-bottom: 1px solid var(--color-border);
    }
  }

  .product-description__modal-close {
    top: var(--margin-2xs);
    right: var(--margin-2xs);
  }
{% endstyle %}

{% schema %}
{
  "name": "t:names.text",
  "tag": null,
  "settings": [
    {
      "type": "richtext",
      "id": "text",
      "label": "t:settings.text"
    },
    {
      "type": "header",
      "content": "Resumen y modal"
    },
    {
      "type": "select",
      "id": "description_display_mode",
      "label": "Modo de descripción",
      "options": [
        {
          "value": "normal",
          "label": "Normal"
        },
        {
          "value": "excerpt_modal",
          "label": "Resumen + modal"
        }
      ],
      "default": "normal"
    },
    {
      "type": "range",
      "id": "description_preview_lines",
      "label": "Líneas visibles",
      "min": 1,
      "max": 50,
      "step": 1,
      "default": 3,
      "visible_if": "{{ block.settings.description_display_mode == 'excerpt_modal' }}"
    },
    {
      "type": "select",
      "id": "description_modal_behavior",
      "label": "Tipo de modal",
      "options": [
        {
          "value": "drawer",
          "label": "Lateral derecho"
        },
        {
          "value": "centered",
          "label": "Centrado"
        }
      ],
      "default": "drawer",
      "visible_if": "{{ block.settings.description_display_mode == 'excerpt_modal' }}"
    },
    {
      "type": "text",
      "id": "description_preview_button_label",
      "label": "Texto del botón",
      "default": "Leer más",
      "visible_if": "{{ block.settings.description_display_mode == 'excerpt_modal' }}"
    },
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "description_content_width",
      "label": "Ancho del contenido",
      "options": [
        {
          "value": "contained",
          "label": "Contenida"
        },
        {
          "value": "full",
          "label": "Página completa"
        }
      ],
      "default": "contained"
    },
    {
      "type": "select",
      "id": "visibility",
      "label": "Visibilidad",
      "options": [
        {
          "value": "",
          "label": "Desktop y móvil"
        },
        {
          "value": "desktop",
          "label": "Solo desktop"
        },
        {
          "value": "mobile",
          "label": "Solo móvil"
        }
      ],
      "default": ""
    },
    {
      "type": "select",
      "id": "width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "fit-content",
          "label": "t:options.fit"
        },
        {
          "value": "100%",
          "label": "t:options.fill"
        }
      ],
      "default": "fit-content"
    },
    {
      "type": "select",
      "id": "max_width",
      "label": "t:settings.max_width",
      "options": [
        {
          "value": "narrow",
          "label": "t:options.narrow"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "none",
          "label": "t:options.none"
        }
      ],
      "default": "normal"
    },
    {
      "type": "text_alignment",
      "id": "alignment",
      "label": "t:settings.alignment",
      "default": "left",
      "visible_if": "{{ block.settings.width == '100%' }}"
    },
    {
      "type": "header",
      "content": "t:content.typography"
    },
    {
      "type": "select",
      "id": "type_preset",
      "label": "t:settings.preset",
      "options": [
        {
          "value": "rte",
          "label": "t:options.default"
        },
        {
          "value": "paragraph",
          "label": "t:options.paragraph"
        },
        {
          "value": "h1",
          "label": "t:options.h1"
        },
        {
          "value": "h2",
          "label": "t:options.h2"
        },
        {
          "value": "h3",
          "label": "t:options.h3"
        },
        {
          "value": "h4",
          "label": "t:options.h4"
        },
        {
          "value": "h5",
          "label": "t:options.h5"
        },
        {
          "value": "h6",
          "label": "t:options.h6"
        },
        {
          "value": "custom",
          "label": "t:options.custom"
        }
      ],
      "default": "rte",
      "info": "t:info.edit_presets_in_theme_settings"
    },
    {
      "type": "select",
      "id": "font",
      "label": "t:settings.font",
      "options": [
        {
          "value": "var(--font-body--family)",
          "label": "t:options.body"
        },
        {
          "value": "var(--font-subheading--family)",
          "label": "t:options.subheading"
        },
        {
          "value": "var(--font-heading--family)",
          "label": "t:options.heading"
        },
        {
          "value": "var(--font-accent--family)",
          "label": "t:options.accent"
        }
      ],
      "default": "var(--font-body--family)",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "font_size",
      "label": "t:settings.size",
      "options": [
        {
          "value": "",
          "label": "t:options.default"
        },
        {
          "value": "0.625rem",
          "label": "10px"
        },
        {
          "value": "0.75rem",
          "label": "12px"
        },
        {
          "value": "0.875rem",
          "label": "14px"
        },
        {
          "value": "1rem",
          "label": "16px"
        },
        {
          "value": "1.125rem",
          "label": "18px"
        },
        {
          "value": "1.25rem",
          "label": "20px"
        },
        {
          "value": "1.5rem",
          "label": "24px"
        },
        {
          "value": "2rem",
          "label": "32px"
        },
        {
          "value": "2.5rem",
          "label": "40px"
        },
        {
          "value": "3rem",
          "label": "48px"
        },
        {
          "value": "3.5rem",
          "label": "56px"
        },
        {
          "value": "4.5rem",
          "label": "72px"
        },
        {
          "value": "5.5rem",
          "label": "88px"
        },
        {
          "value": "7.5rem",
          "label": "120px"
        },
        {
          "value": "9.5rem",
          "label": "152px"
        },
        {
          "value": "11.5rem",
          "label": "184px"
        }
      ],
      "default": "1rem",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "line_height",
      "label": "t:settings.line_height",
      "options": [
        {
          "value": "tight",
          "label": "t:options.tight"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "loose",
          "label": "t:options.loose"
        }
      ],
      "default": "normal",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "letter_spacing",
      "label": "t:settings.letter_spacing",
      "options": [
        {
          "value": "tight",
          "label": "t:options.tight"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "loose",
          "label": "t:options.loose"
        }
      ],
      "default": "normal",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "case",
      "label": "t:settings.case",
      "options": [
        {
          "value": "none",
          "label": "t:options.default"
        },
        {
          "value": "uppercase",
          "label": "t:options.uppercase"
        }
      ],
      "default": "none",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "wrap",
      "label": "t:settings.wrap",
      "options": [
        {
          "value": "pretty",
          "label": "t:options.pretty"
        },
        {
          "value": "balance",
          "label": "t:options.balance"
        },
        {
          "value": "nowrap",
          "label": "t:options.none"
        }
      ],
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "color",
      "label": "t:settings.color",
      "options": [
        {
          "value": "var(--color-foreground)",
          "label": "t:options.text"
        },
        {
          "value": "var(--color-foreground-heading)",
          "label": "t:options.heading"
        },
        {
          "value": "var(--color-primary)",
          "label": "t:options.link"
        }
      ],
      "default": "var(--color-foreground)",
      "visible_if": "{{ block.settings.type_preset != 'rte' }}"
    },
    {
      "type": "header",
      "content": "t:content.appearance"
    },
    {
      "type": "checkbox",
      "id": "background",
      "label": "t:settings.background",
      "default": false
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "t:settings.background_color",
      "alpha": true,
      "default": "#00000026",
      "visible_if": "{{ block.settings.background }}"
    },
    {
      "type": "range",
      "id": "corner_radius",
      "label": "t:settings.corner_radius",
      "default": 0,
      "min": 0,
      "max": 50,
      "step": 1,
      "visible_if": "{{ block.settings.background }}"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "t:names.product_description",
      "category": "t:categories.product"
    }
  ]
}
{% endschema %}
