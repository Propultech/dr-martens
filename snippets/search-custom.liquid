{%- doc -%}
  Renders a custom inline search component with predictive search.
  Mobile: Button that expands a search panel below
  Desktop: Inline search input

  @param {string} [placeholder] - The placeholder text for the search input.
  @param {string} [class] - Additional classes for the search container.
  @param {string} [unique_id] - Unique identifier for multiple instances.
  @param {string} [color_scheme] - Color scheme to apply (e.g., 'scheme-1', 'scheme-2').
  @param {string} [mode] - Rendering mode: 'full' (default), 'button-desktop', or 'panel'.

  @example
  {% render 'search-custom', placeholder: 'Busca productos...', class: 'custom-class', unique_id: 'header', color_scheme: 'scheme-1', mode: 'button-desktop' %}
{%- enddoc -%}

{%- liquid
  assign section_id = unique_id | default: 'inline'
  assign placeholder_text = placeholder | default: 'Busca botas, zapatos, sandalias y m√°s'

  # Determine what to render based on mode
  # mode: 'full' (default) = button + desktop + panel
  # mode: 'button-desktop' = only button + desktop (no panel)
  # mode: 'panel' = only mobile panel
  assign render_mode = mode | default: 'full'

  # Determine what to render
  if render_mode == 'panel'
    assign should_render_mobile_panel = true
    assign should_render_button_desktop = false
  elsif render_mode == 'button-desktop'
    assign should_render_mobile_panel = false
    assign should_render_button_desktop = true
  else
    # mode: 'full' - render everything
    assign should_render_mobile_panel = true
    assign should_render_button_desktop = true
  endif
-%}

{%- if should_render_button_desktop -%}
  <search-custom-component
    class="search-custom-wrapper{% if class != blank %} {{ class | strip }}{% endif %}"
    data-unique-id="{{ section_id }}"
  >
    {%- comment -%} Mobile: Toggle button only (panel rendered separately in header row) {%- endcomment -%}
    <button
      type="button"
      class="search-custom-mobile__trigger color-{{ color_scheme }} desktop:hidden"
      aria-label="{{ 'content.search_input_label' | t }}"
      aria-expanded="false"
      aria-controls="search-custom-mobile-panel-{{ section_id }}"
      ref="mobileTrigger"
    >
      <span class="search-custom-mobile__icon search-custom-mobile__icon--search" aria-hidden="true" ref="searchIcon">
        {{ 'icon-search.svg' | inline_asset_content }}
      </span>
      <span
        class="search-custom-mobile__icon search-custom-mobile__icon--close"
        aria-hidden="true"
        ref="closeIcon"
        hidden
      >
        {{ 'icon-close.svg' | inline_asset_content }}
      </span>
    </button>

    {%- comment -%} Desktop: Inline search {%- endcomment -%}
    <div class="search-custom-desktop color-{{ color_scheme }} mobile:hidden">
      <predictive-search-component
        class="predictive-search-component"
        data-section-id="predictive-search"
        data-testid="search-component--desktop"
        role="search"
        aria-label="{{ 'content.search_input_label' | t }}"
      >
        <form
          action="{{ routes.search_url }}"
          method="get"
          role="search"
          class="search-custom-form"
          id="search-custom-form-desktop-{{ section_id }}"
          ref="form"
          on:keydown="/onSearchKeyDown"
        >
          <div class="search-custom-input-wrapper">
            <span class="search-custom-icon search-custom-icon--search" aria-hidden="true">
              {{ 'icon-search.svg' | inline_asset_content }}
            </span>

            <button
              type="reset"
              ref="resetButton"
              class="search-custom-clear"
              aria-label="{{ 'actions.clear' | t }}"
              hidden
              on:click="/resetSearch"
            >
              <span class="svg-wrapper" aria-hidden="true">
                {{ 'icon-close.svg' | inline_asset_content }}
              </span>
            </button>

            <label for="search-custom-desktop-input-{{ section_id }}" class="visually-hidden">
              {{ 'content.search_input_label' | t }}
            </label>

            {% comment %} in case of pass search {{ search.terms | escape }} {% endcomment %}
            <input
              id="search-custom-desktop-input-{{ section_id }}"
              ref="searchInput"
              type="search"
              name="q"
              value=""
              placeholder="{{ placeholder_text }}"
              class="search-custom-input"
              role="combobox"
              aria-expanded="false"
              aria-owns="search-custom-desktop-results-{{ section_id }}"
              aria-controls="search-custom-desktop-results-{{ section_id }}"
              aria-haspopup="listbox"
              aria-autocomplete="list"
              autocomplete="off"
              on:input="/search"
              on:keydown="/onSearchKeyDown"
            >
          </div>

          <input name="options[prefix]" type="hidden" value="last">
        </form>

        <div class="predictive-search-form__content-wrapper">
          <div
            id="search-custom-desktop-results-{{ section_id }}"
            ref="predictiveSearchResults"
            class="search-custom-results"
            tabindex="-1"
            hidden
            data-search-results
            scroll-lock
          >
            {% render 'predictive-search-empty-state',
              load_empty_state: true,
              shadow_opacity: 0.1,
              products_test_id: 'products-list-default--modal'
            %}
          </div>

          <div class="predictive-search-form__footer">
            <button
              class="button button-primary predictive-search__search-button"
              type="submit"
              form="search-custom-form-desktop-{{ section_id }}"
              ref="viewAllButton"
            >
              {{ 'content.search_results_view_all' | t }}
            </button>
          </div>
        </div>
      </predictive-search-component>
    </div>
  </search-custom-component>
{%- endif -%}

{%- if should_render_mobile_panel -%}
  {%- comment -%} Mobile panel {%- endcomment -%}
  <div
    id="search-custom-mobile-panel-{{ section_id }}"
    class="search-custom-mobile-panel desktop:hidden color-{{ color_scheme }}"
    hidden
    ref="mobilePanel"
    data-mobile-panel="true"
  >
    <predictive-search-component
      class="predictive-search-component"
      data-section-id="predictive-search"
      data-testid="search-component--desktop"
      role="search"
      aria-label="{{ 'content.search_input_label' | t }}"
    >
      <form
        action="{{ routes.search_url }}"
        method="get"
        role="search"
        class="search-custom-form"
        id="search-custom-form-mobile-{{ section_id }}"
        ref="form"
        on:keydown="/onSearchKeyDown"
      >
        <div class="search-custom-input-wrapper">
          <label for="search-custom-mobile-input-{{ section_id }}" aria-hidden="true" class="visually-hidden">
            {{ 'content.search_input_label' | t }}
          </label>

          <button
            type="reset"
            ref="resetButton"
            class="search-custom-reset"
            aria-label="{{ 'actions.clear' | t }}"
            hidden
            on:click="/resetSearch"
          >
            <span class="svg-wrapper" aria-hidden="true">
              {{ 'icon-close.svg' | inline_asset_content }}
            </span>
          </button>

          <span class="search-custom-button" aria-hidden="false" ref="searchIcon">
            {{ 'icon-search.svg' | inline_asset_content }}
          </span>

          <input
            id="search-custom-mobile-input-{{ section_id }}"
            ref="searchInput"
            type="search"
            name="q"
            value="{{ search.terms | escape }}"
            placeholder="{{ placeholder_text }}"
            class="search-custom-input"
            role="combobox"
            aria-expanded="false"
            aria-owns="search-custom-mobile-results-{{ section_id }}"
            aria-controls="search-custom-mobile-results-{{ section_id }}"
            aria-haspopup="listbox"
            aria-autocomplete="list"
            autocomplete="off"
            on:input="/search"
            on:keydown="/onSearchKeyDown"
          >
        </div>

        <input name="options[prefix]" type="hidden" value="last">
      </form>

      <div class="predictive-search-form__content-wrapper">
        <div
          id="search-custom-mobile-results-{{ section_id }}"
          ref="predictiveSearchResults"
          class="search-custom-results"
          tabindex="-1"
          hidden
          data-search-results
          scroll-lock
        >
          {% render 'predictive-search-empty-state',
            load_empty_state: true,
            shadow_opacity: 0.1,
            products_test_id: 'products-list-default--modal'
          %}
        </div>

        <div class="predictive-search-form__footer">
          <button
            class="button button-primary predictive-search__search-button"
            type="submit"
            form="search-custom-form-mobile-{{ section_id }}"
            ref="viewAllButton"
          >
            {{ 'content.search_results_view_all' | t }}
          </button>
        </div>
      </div>
    </predictive-search-component>
  </div>
{%- endif -%}

{% stylesheet %}
  .header-search-custom {
    .visually-hidden {
      position: absolute !important;
      height: 0px;
      width: 0px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap;
      visibility: hidden;
    }

    .search-custom-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;

      .search-custom-form {
        display: flex;
        align-items: center;
        height: 40px;
        width: clamp(300px, 27.5vw, 396px);
        background-color: var(--color-background);
        padding: 6px;

        .search-custom-input-wrapper {
          display: flex;
          gap: 6px;
          position: relative;
          width: 100%;

          .search-custom-icon {
            display: block;
            width: 28px;
            height: 28px;
          }

          &:has(.search-custom-clear:not([hidden])) {
            .search-custom-icon {
              display: none;
            }
          }

          .search-custom-clear {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            color: var(--color-foreground);
            width: 28px;
            height: 28px;
          }

          .search-custom-input {
            background-color: var(--color-background);
            color: var(--color-foreground);
            border: none;
            font-size: 16px;
            line-height: normal;
            flex: 1;

            &:focus {
              outline: none;
            }

            &::placeholder {
              color: var(--color-foreground);
            }
          }
        }
      }
    }

    .predictive-search-component {
      display: flex;
      flex-flow: column;
      position: relative;

      .predictive-search-form__content-wrapper {
        width: 100%;
        position: absolute;
        top: 40px;
        display: flex;
        opacity: 1;
        background: var(--color-foreground);
        transform: translateY(0);
        transition: opacity 0.3s ease, transform 0.3s ease;
        box-shadow: var(--shadow-popover);
        max-height: 70dvh;

        @starting-style {
          opacity: 0;
          transform: translateY(-10px);
        }

        &:has(.predictive-search-results__inner[data-search-results]):not(:has(.predictive-search-results__no-results)) {
          padding: 0 0 80px;
        }

        &:has(.search-custom-results[hidden]) {
          display: none;
          opacity: 0;
        }

        .predictive-search-form__footer {
          transition: height 0s, opacity .2s ease, display 0s allow-discrete;

          @starting-style {
            opacity: 0;
            height: 0;
          }
        }

        .search-custom-results {
          overflow-y: auto;
          scrollbar-width: none;
        }
      }
    }
  }

  /* mobile  */
  .search-custom-mobile__trigger {
    background-color: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;

    &:focus {
      outline: none;
      background-color: transparent;
    }

    .search-custom-mobile__icon {
      display: block;
      color: var(--color-foreground);
      width: 28px;
      height: 28px;

      &.search-custom-mobile__icon--close {
        width: 20px;
        height: 20px;
      }

      &[hidden] {
        display: none;
      }

      svg {
        width: 100%;
        height: 100%;
      }
    }
  }

  .header__row--mobile.header__row--search {
    background-color: var(--color-variant-text);
    display: grid;
    grid-template-rows: 1fr;
    transition: grid-template-rows 0.4s ease, display 0.4s allow-discrete;

    &:has(.search-custom-mobile-panel[hidden]) {
      grid-template-rows: 0fr;
    }

    > div {
      padding: 0 var(--page-margin);
      background-color: transparent;
    }

    .search-custom-mobile-panel {
      display: block;
      opacity: 1;
      transition: height 0s ,opacity .0s ease, display .5s allow-discrete ease;

      &[hidden] {
        display: none;
        opacity: 0;
        height: 0;
      }

      @starting-style {
        opacity: 0;
        height: 0;
      }
    }

    .predictive-search-component {
      position: relative;
      display: flex;
      flex-flow: column;
      gap: 10px;

      .predictive-search-form__content-wrapper {
        position: relative;
        max-height: 62dvh;
        z-index: 0;
        overflow-y: auto;
        scrollbar-width: none;
        background-color: var(--color-foreground);

        .predictive-search-form__footer {
          position: relative;
          transition: opacity .2s ease, display .5s allow-discrete;
          margin: 10px 0 0;

          @starting-style {
            opacity: 0;
          }
        }
      }
    }

    .predictive-search-component,
    .search-custom-form {
      width: 100%;
      background-color: transparent;
    }

    .search-custom-input-wrapper {
      display: flex;
      width: 100%;
      gap: 6px;
      align-items: center;
      justify-content: center;
      background-color: var(--color-foreground);

      .search-custom-button {
        display: block;
        width: 28px;
        height: 28px;
        color: var(--color-variant-text);
      }

      &:has(.search-custom-reset:not([hidden])) {
        .search-custom-button {
          display: none;
        }
      }

      .search-custom-reset {
        position: relative;
        top: 2px;
        width: 28px;
        height: 28px;
        color: var(--color-variant-text);
        border: none;
        background-color: transparent;
        cursor: pointer;
        padding: 0;
      }

      .search-custom-input {
        background-color: var(--color-foreground);
        color: var(--color-variant-text);
        border: none;
        font-size: 16px;
        line-height: normal;
        flex: 1;
        height: 54px;
        border-radius: 0;

        &:focus {
          outline: none;
        }

        &::placeholder {
          color: var(--color-background);
        }
      }
    }
  }

  /* search response */
  .header__row--mobile.header__row--search,
  .header-search-custom {
    .predictive-search-form__content-wrapper {
      .predictive-search-form__footer {
        display: none;
        opacity: 0;
      }

      &:has(.predictive-search-results__inner[data-search-results]):not(:has(.predictive-search-results__no-results)) {
        .predictive-search-form__footer {
          display: block;
          opacity: 1;
        }
      }

      .predictive-search-results__inner {
        color: var(--color-variant-text);
        padding: 0;
        scrollbar-width: none;

        .resource-card__content,
        .paragraph {
          color: var(--color-variant-text);
        }

        .predictive-search-results__products,
        .predictive-search-results__list {
          padding: 0;

          .predictive-search-results__resource-header {
            padding: 0;
            height: auto;
          }

          slideshow-container {
            padding: 0;
          }
        }

        .predictive-search-results__list {
          grid-template-columns: repeat(1, 1fr);
          gap: 0;
        }

        /* query */
        .predictive-search-results__wrapper-queries {
          flex-flow: column;

          .predictive-search-results__card--query {
            border-bottom: 1px solid var(--color-variant-text);

            &:last-child {
              border-bottom: none;
            }

            &:active {
              transform: scale(1);
            }
          }

          .predictive-search-results__pill {
            color: var(--color-variant-text);
            margin: 0;
            padding: var(--padding-sm);

            &:hover {
              transform: scale(1);
              box-shadow: none;
              background-color: var(--card-bg-hover);
            }

            mark {
              color: var(--color-variant-text);
              font-weight: bold;
            }
          }
        }

        /* product */
        .predictive-search-results__card--product {
          border-bottom: 1px solid var(--color-variant-text);
          padding: var(--padding-sm);

          &:last-child {
            border-bottom: none;
          }

          &:hover {
            padding: var(--padding-sm);
            margin: 0;
          }

          &:active {
            transform: scale(1);
          }

          .resource-card {
            flex-flow: row;
            gap: var(--gap-md);

            .resource-card__media {
              flex: 0 0 80px;
              display: flex;
              position: relative;
            }

            .resource-card__content {
              padding: var(--gap-md) 0 0;

              .resource-card__title {
                text-transform: uppercase;
                font-weight: bolder;
                -webkit-line-clamp: 1;
                line-clamp: 1;
              }
            }
          }
        }

        /* collections & pages */
        .predictive-search-results__wrapper {
          slideshow-slides {
            padding: var(--padding-xl) var(--padding-sm) var(--padding-xl);
          }

          .predictive-search-results__card:not(.predictive-search-results__card--product) {
            border: none;
            background-color: var(--card-bg-hover);

            &:hover {
              opacity: .8;
            }
          }
        }

        /* title */
        .predictive-search-results__title {
          text-transform: uppercase;
          background-color: var(--color-variant-hover-text);
          font-weight: bolder;
          outline: 1px solid var(--color-variant-text);
          padding: 3px 5px;
          margin: 0;
          line-height: normal;

          .predictive-search-results__clear {
            display: none;
          }
        }
      }
    }
  }

{% endstylesheet %}
